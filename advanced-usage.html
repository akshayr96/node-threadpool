<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Advanced Usage | node-threadpool</title>
    <meta name="description" content="Thread pools using native threads for node.js">
    
    
    <link rel="preload" href="/node-threadpool/assets/css/5.styles.aadff285.css" as="style"><link rel="preload" href="/node-threadpool/assets/js/app.203b2191.js" as="script"><link rel="preload" href="/node-threadpool/assets/js/3.1a8f0c72.js" as="script"><link rel="prefetch" href="/node-threadpool/assets/js/0.754dcb0b.js"><link rel="prefetch" href="/node-threadpool/assets/js/1.1a225d14.js"><link rel="prefetch" href="/node-threadpool/assets/js/2.b1534575.js"><link rel="prefetch" href="/node-threadpool/assets/js/4.c0fc3d12.js">
    <link rel="stylesheet" href="/node-threadpool/assets/css/5.styles.aadff285.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/node-threadpool/" class="home-link router-link-active"><!----><span class="site-name">
      node-threadpool
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="https://psastras.github.io/node-threadpool/api" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API Reference
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/psastras/node-threadpool" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://psastras.github.io/node-threadpool/api" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API Reference
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/psastras/node-threadpool" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav><ul class="sidebar-links"><li><a href="/node-threadpool/" class="sidebar-link">Home</a></li><li><a href="/node-threadpool/installation.html" class="sidebar-link">Installation</a></li><li><a href="/node-threadpool/usage.html" class="sidebar-link">Usage</a></li><li><a href="/node-threadpool/advanced-usage.html" class="active sidebar-link">Advanced Usage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-threadpool/advanced-usage.html#passing-data" class="sidebar-link">Passing Data</a></li><li class="sidebar-sub-header"><a href="/node-threadpool/advanced-usage.html#sharing-data" class="sidebar-link">Sharing Data</a></li></ul></li><li><a href="/node-threadpool/examples.html" class="sidebar-link">Examples</a></li></ul></div><div class="page"><div class="content"><h1 id="advanced-usage"><a href="#advanced-usage" aria-hidden="true" class="header-anchor">#</a> Advanced Usage</h1><h2 id="passing-data"><a href="#passing-data" aria-hidden="true" class="header-anchor">#</a> Passing Data</h2><p>Worker threads can only access data within the thread's (or the submmited functions) context. In order to operate on data in the main thread, data must be copied from the main thread to each worker thread which needs to access it.</p><p>This can be done by passing in a second argument to <code>submit(...)</code>. The value in the second argument will be copied over to the worker thread and is passed into the submitted function.</p><p>Note that since this is a copy of the data, any writes to the data in the worker thread are not reflected in the main (original) thread's data. Instead return results from the runnable function.</p><p>Some examples:</p><h3 id="copy-a-string"><a href="#copy-a-string" aria-hidden="true" class="header-anchor">#</a> Copy a String</h3><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> pool <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadedExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// the string &quot;string to copy&quot; is passed to the worker thread and accessible via the data argument</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">async</span> data <span class="token operator">=&gt;</span> data<span class="token punctuation">,</span> <span class="token string">&quot;string to copy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints &quot;string to copy&quot;</span>
</code></pre></div><h3 id="copy-an-object"><a href="#copy-an-object" aria-hidden="true" class="header-anchor">#</a> Copy an Object</h3><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> pool <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadedExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  map
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// the object is passed to the worker thread and accessible via the data argument</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">async</span> data <span class="token operator">=&gt;</span> data<span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints &quot;value&quot;</span>
</code></pre></div><p>Most plain javascript object types are supported when copying data. Some notable exceptions are circular references and class instances.</p><h2 id="sharing-data"><a href="#sharing-data" aria-hidden="true" class="header-anchor">#</a> Sharing Data</h2><p><code>node-threadpool</code> and <code>worker_thread</code>s support sharing data between threads. Unlike copying data, sharing data allows threads to read and write each other's results (and also avoids the copy overhead).</p><p>Be aware that writing to the same piece of data can be dangerous if the data is written to at the same time. The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics" target="_blank" rel="noopener noreferrer">Atomics API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> can help with this.</p><p>Data can be shared with worker threads in the same way data can be copied to the worker threads. If the type of data is <code>SharedArrayBuffer</code> it will be shared instead of copied.</p><p>For example,</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> Int32Array<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>sharedBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// provide a view onto the buffer</span>

<span class="token comment">// theres no lock, so in order to write safely we'll use one thread for this toy example</span>
<span class="token comment">// see the next example for atomic usage</span>
<span class="token keyword">const</span> pool <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadedExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// set the data in the shared buffer to 42</span>
<span class="token keyword">await</span> pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">async</span> d <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// read the data from the shared buffer</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">async</span> d <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 42</span>
</code></pre></div></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/node-threadpool/usage.html" class="prev">
          Usage
        </a></span><span class="next"><a href="/node-threadpool/examples.html">
          Examples
        </a> →
      </span></p></div></div></div></div>
    <script src="/node-threadpool/assets/js/3.1a8f0c72.js" defer></script><script src="/node-threadpool/assets/js/app.203b2191.js" defer></script>
  </body>
</html>
