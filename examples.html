<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Examples | node-threadpool</title>
    <meta name="description" content="Thread pools using native threads for node.js">
    
    
    <link rel="preload" href="/node-threadpool/assets/css/5.styles.aadff285.css" as="style"><link rel="preload" href="/node-threadpool/assets/js/app.7afa63a1.js" as="script"><link rel="preload" href="/node-threadpool/assets/js/2.b1534575.js" as="script"><link rel="prefetch" href="/node-threadpool/assets/js/0.754dcb0b.js"><link rel="prefetch" href="/node-threadpool/assets/js/1.7e5ebd19.js"><link rel="prefetch" href="/node-threadpool/assets/js/3.1a8f0c72.js"><link rel="prefetch" href="/node-threadpool/assets/js/4.76eb9d95.js">
    <link rel="stylesheet" href="/node-threadpool/assets/css/5.styles.aadff285.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/node-threadpool/" class="home-link router-link-active"><!----><span class="site-name">
      node-threadpool
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="https://psastras.github.io/node-threadpool/api" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API Reference
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/psastras/node-threadpool" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://psastras.github.io/node-threadpool/api" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API Reference
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/psastras/node-threadpool" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav><ul class="sidebar-links"><li><a href="/node-threadpool/" class="sidebar-link">Home</a></li><li><a href="/node-threadpool/installation.html" class="sidebar-link">Installation</a></li><li><a href="/node-threadpool/usage.html" class="sidebar-link">Usage</a></li><li><a href="/node-threadpool/advanced-usage.html" class="sidebar-link">Advanced Usage</a></li><li><a href="/node-threadpool/examples.html" class="active sidebar-link">Examples</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-threadpool/examples.html#basic-usage" class="sidebar-link">Basic Usage</a></li><li class="sidebar-sub-header"><a href="/node-threadpool/examples.html#passing-data" class="sidebar-link">Passing Data</a></li><li class="sidebar-sub-header"><a href="/node-threadpool/examples.html#shared-array-buffers" class="sidebar-link">Shared Array Buffers</a></li><li class="sidebar-sub-header"><a href="/node-threadpool/examples.html#atomics" class="sidebar-link">Atomics</a></li></ul></li></ul></div><div class="page"><div class="content"><h1 id="examples"><a href="#examples" aria-hidden="true" class="header-anchor">#</a> Examples</h1><h2 id="basic-usage"><a href="#basic-usage" aria-hidden="true" class="header-anchor">#</a> Basic Usage</h2><p>To submit work to a thread pool, create a method which returns a promise.</p><p>In this example, the method is declared inline and returns a <code>Promise&lt;string&gt;</code>.</p><p>After completion of work, the thread pool resolves the promise with the value.</p><p>We use <code>await</code> to wait until the result is available then print it to <code>console.log</code>.</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> pool <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints &quot;hello world&quot;</span>
</code></pre></div><h2 id="passing-data"><a href="#passing-data" aria-hidden="true" class="header-anchor">#</a> Passing Data</h2><p>Thread pool functions cannot access data outside of the function's context. This is because the worker runs in a separate thread and cannot access data in the main thread.</p><p>The easiest way to get data into the worker thread is to copy it. This can be done by providing <code>submit</code> two arguments (the first is the runnable function, the second is the data to copy).</p><p>Most standard data is supported. Class instances and data with circular references notably are not supported.</p><p>Note that each worker receives a <em>copy</em> of the data -- changes made within each thread do not affect the original data.</p><p>In the following example, a Map is copied into the worker thread for data access.</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> pool <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadedExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  map
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">async</span> d <span class="token operator">=&gt;</span> d<span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints &quot;value&quot;</span>
</code></pre></div><h2 id="shared-array-buffers"><a href="#shared-array-buffers" aria-hidden="true" class="header-anchor">#</a> Shared Array Buffers</h2><p>Node's <code>worker_thread</code> API supports shared memory between threads. Unlike copying data directly to each worker, shared memory avoids the copy overhead and allows threads to communicate to each other by reading and writing to the same area of memory.</p><p><code>node-threadpool</code> supports shared memory -- if you pass data of type
<code>SharedArrayBuffer</code> in the <code>submit</code> function, it will automatically be accessible from each thread.</p><p>In the following example, a shared buffer is created to hold a single integer. This integer is then written to in the first thread, and read and returned in the second thead. Note that we could also read and write to the same buffer from the main thread.</p><p>Also note that a single thread executor is used to avoid concurrent threads reading and writing to the same memory at the same time (see the next example using Atomics which does this safely).</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> Int32Array<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>sharedBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// provide a view onto the buffer</span>

<span class="token comment">// theres no lock, so in order to write safely we'll use one thread for this toy example</span>
<span class="token comment">// see the next example for atomic usage</span>
<span class="token keyword">const</span> pool <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadedExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// set the data in the shared buffer to 42</span>
<span class="token keyword">await</span> pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">async</span> d <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// read the data from the shared buffer</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">async</span> d <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 42</span>
</code></pre></div><h2 id="atomics"><a href="#atomics" aria-hidden="true" class="header-anchor">#</a> Atomics</h2><p>For threads to access and write to the same elements in <code>SharedArrayBuffers</code>, Atomic operations are needed (ex. to implment locks and mutexes). In this example, the same area of memory is accessed in the main thread and the worker thread.</p><p>The worker thread waits until the memory has been changed (by the main thread's <code>Atomics.store</code>), then continues with its operation.</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> Int32Array<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pool <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadedExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">async</span> d <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Atomics<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// wait here until the value is no longer 0</span>
  <span class="token keyword">return</span> Atomics<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

Atomics<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// change the value from 0, unblocking the worker thread</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 1</span>
</code></pre></div></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/node-threadpool/advanced-usage.html" class="prev">
          Advanced Usage
        </a></span><!----></p></div></div></div></div>
    <script src="/node-threadpool/assets/js/2.b1534575.js" defer></script><script src="/node-threadpool/assets/js/app.7afa63a1.js" defer></script>
  </body>
</html>
